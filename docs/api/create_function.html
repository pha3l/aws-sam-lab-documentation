
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Create Poll Function Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fancybox/jquery.fancybox.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="get_function.html" />
    
    
    <link rel="prev" href="dynamo_config.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../setup.html">
            
                <a href="../setup.html">
            
                    
                    Development Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    Part I - API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="project_setup.html">
            
                <a href="project_setup.html">
            
                    
                    Project Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="dynamo_config.html">
            
                <a href="dynamo_config.html">
            
                    
                    DynamoDB Table Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.3" data-path="create_function.html">
            
                <a href="create_function.html">
            
                    
                    Create Poll Function
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="get_function.html">
            
                <a href="get_function.html">
            
                    
                    Get Poll Function
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="list_function.html">
            
                <a href="list_function.html">
            
                    
                    List Poll Function
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="vote_function.html">
            
                <a href="vote_function.html">
            
                    
                    Vote Function
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="deployment.html">
            
                <a href="deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../client/intro.html">
            
                <a href="../client/intro.html">
            
                    
                    Part II - Client App
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../client/poll_service.html">
            
                <a href="../client/poll_service.html">
            
                    
                    Poll Service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../client/polls_component.html">
            
                <a href="../client/polls_component.html">
            
                    
                    Polls Component
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../client/poll_component.html">
            
                <a href="../client/poll_component.html">
            
                    
                    Poll Component
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../client/new_poll_form_component.html">
            
                <a href="../client/new_poll_form_component.html">
            
                    
                    New Poll Form Component
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../client/deployment.html">
            
                <a href="../client/deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Create Poll Function</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="authoring-the-create-function">Authoring the Create Function</h1>
<p>With Typescript, we can use an interface to define the structure and expected properties (and their types) of an object, and use this to our advantage as we write our application to provide type-checking.  We&apos;ll use this to ensure we have a consistent data model across all of our functions.  Let&apos;s start by defining an interface, <code>poll.model.ts</code>, at the root of the <code>src</code> folder:</p>
<p><code>src/poll.model.ts</code></p>
<pre class="language-"><code class="lang-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Poll</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    title<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    question<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    answers<span class="token punctuation">:</span> <span class="token keyword">Array</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    createdAt<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
    updatedAt<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>But we also need a way to track the number of votes for each answer.  In the same file below the <code>Poll</code> interface definition, create another interface, <code>PollAnswer</code> as follows:</p>
<pre class="language-"><code class="lang-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PollAnswer</span> <span class="token punctuation">{</span>
    answer<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    votes<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And then change the type of the <code>answers</code> property to <code>Array<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PollAnswer</span><span class="token punctuation">&gt;</span></span></code>.</p>
<p>The final file should look like this now:</p>
<pre class="language-"><code class="lang-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Poll</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    title<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    question<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    answers<span class="token punctuation">:</span> <span class="token keyword">Array</span><span class="token operator">&lt;</span>PollAnswer<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    createdAt<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
    updatedAt<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PollAnswer</span> <span class="token punctuation">{</span>
    answer<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    votes<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now, we want to avoid duplicating code between our functions so let&apos;s implement a basic repository design pattern that will abstract the <a href="../GLOSSARY.html#dynamodb" class="glossary-term" title="AWS&apos;s highly scalable document-based NoSQL database solution">DynamoDB</a> logic.  With only one table/model, this may seem like overkill, but in a more complex project it&apos;s a great way to DRY up the persistence logic.  Create a file <code>dynamo-repository.ts</code>:</p>
<p><code>src/dynamo-repository.ts</code></p>
<pre class="language-"><code class="lang-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> DocumentClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;aws-sdk/lib/dynamodb/document_client&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DynamoDB <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;aws-sdk&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PutItemInput<span class="token punctuation">,</span> PutItemOutput <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;aws-sdk/clients/dynamodb&apos;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DynamoRepository</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> dynamoClient <span class="token punctuation">:</span> DocumentClient<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> tableName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tableName<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/.*-test$/g</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Using local Dynamo table: &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dynamoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamoDB<span class="token punctuation">.</span>DocumentClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                endpoint<span class="token punctuation">:</span> <span class="token string">&apos;http://172.16.123.1:8000&apos;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dynamoClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamoDB<span class="token punctuation">.</span>DocumentClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">create</span><span class="token punctuation">(</span>entity<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PutItemOutput<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
            TableName<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tableName<span class="token punctuation">,</span>
            Item<span class="token punctuation">:</span> entity as Object
        <span class="token punctuation">}</span> as PutItemInput<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>PutItemOutput<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dynamoClient<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>What we&apos;ve done here is create a generic repository class that will work with any table/entity.  Note the constructor--we&apos;ve set it up to check the name of the table against a regular expression looking for a <code>-test</code> suffix.  If it&apos;s there, we&apos;ll instantiate the <code>DocumentClient</code> with a local endpoint.  We&apos;re using this sort of strange suffix strategy to prevent introducing an additional environment variable because for <code>sam-local</code> to pick up environment variables, they have to be defined in the template, and we don&apos;t really want to add one to the production environment just so our tests will run properly.  All this will allow us to use a local Dynamo table for testing.  The IP we&apos;ve used, <code>172.16.123.1</code>, is a random IP in the private IP space.  The reason that we&apos;re not just using <code>localhost</code> here is because when we test our functions with <code>sam local</code>, the functions will run in a docker container, while the Dynamo Local endpoint will be on localhost.  Therefore we&apos;ll have to set up an alias so the function can find localhost a little later.</p>
<p>Along the same lines, let&apos;s create a class to represent the response that <a href="../GLOSSARY.html#api-gateway" class="glossary-term" title="AWS service that facilitates the creation and management of scalable and secure APIs">API Gateway</a> expects when invoking the <a href="../GLOSSARY.html#lambda" class="glossary-term" title="AWS&apos;s Function-as-a-Service platform">lambda</a> on the user&apos;s behalf.  Setting the <code>Access-Control-Allow-Origin</code> header is <strong>VERY IMPORTANT</strong>, as we&apos;ll be interacting with the API via AJAX calls, and thus CORS will be an issue. Create a file <code>api-gateway-response.ts</code>:</p>
<p><code>src/api-gateway-response.ts</code></p>
<pre class="language-"><code class="lang-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ApiGatewayResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> statusCode<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> headers<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> body<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> isBase64Encoded<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>responseType<span class="token punctuation">:</span> ResponseType<span class="token punctuation">,</span> body<span class="token punctuation">:</span> Object<span class="token punctuation">,</span> isBase64Encoded<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statusCode <span class="token operator">=</span> responseType<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isBase64Encoded <span class="token operator">=</span> isBase64Encoded <span class="token operator">||</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">enum</span> ResponseType <span class="token punctuation">{</span>
    OK <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
    SERVER_ERROR <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>
    NOT_FOUND <span class="token operator">=</span> <span class="token number">404</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Unlike relational database systems that you may be more familiar with, <a href="../GLOSSARY.html#dynamodb" class="glossary-term" title="AWS&apos;s highly scalable document-based NoSQL database solution">DynamoDB</a> and other object-based NoSQL databases don&apos;t have a utility for generating unique identifiers built in, so let&apos;s add an NPM package to help us generate them in our function:</p>
<pre class="language-"><code>$ npm install --save uuid
</code></pre><p>We installed the <code>uuid</code> package with the <code>--save</code> flag, which means that it will not only be installed to <code>node_modules</code>, but will be added to our <code>package.json</code>.</p>
<p>While we&apos;re on the subject of npm dependencies, you might have noticed that the <code>aws-sdk</code> is specified as a dev dependency.  This is because <a href="../GLOSSARY.html#lambda" class="glossary-term" title="AWS&apos;s Function-as-a-Service platform">lambda</a> provides this in the execution environment, so we don&apos;t need to bundle it, which is great because it&apos;s a large package.</p>
<p>Now we have all the pieces in place, and we can implement the actual function.  Create the file <code>create-poll.function.ts</code>:</p>
<p><code>src/create-poll.function.ts</code></p>
<pre class="language-"><code class="lang-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Handler<span class="token punctuation">,</span> APIGatewayEvent<span class="token punctuation">,</span> Context<span class="token punctuation">,</span> Callback <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;aws-lambda&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> v4 as uuid <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;uuid&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Poll <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;./poll.model&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DynamoRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;./dynamo-repository&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiGatewayResponse<span class="token punctuation">,</span> ResponseType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&apos;./api-gateway-response&apos;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> handler<span class="token punctuation">:</span> Handler <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">:</span> APIGatewayEvent<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Context<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> Callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> poll <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>body<span class="token punctuation">)</span> as Poll<span class="token punctuation">;</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    poll<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> now<span class="token punctuation">;</span>
    poll<span class="token punctuation">.</span>updatedAt <span class="token operator">=</span> now<span class="token punctuation">;</span>
    poll<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">new</span> <span class="token class-name">DynamoRepository</span><span class="token operator">&lt;</span>Poll<span class="token operator">&gt;</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>TABLE_NAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>poll<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ApiGatewayResponse</span><span class="token punctuation">(</span>ResponseType<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> poll<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ApiGatewayResponse</span><span class="token punctuation">(</span>ResponseType<span class="token punctuation">.</span>SERVER_ERROR<span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The last step is to describe our function within the <a href="../GLOSSARY.html#cloudformation" class="glossary-term" title="AWS&apos;s infrastructure-as-code service">CloudFormation</a> template.  Remove the section for the HelloWorldSample function and add the following under the Dynamo table in <code>template.yml</code>:</p>
<p><code>template.yml</code></p>
<pre class="language-"><code class="lang-yaml"><span class="token punctuation">...</span>
<span class="token key atrule">CreatePoll</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Serverless<span class="token punctuation">:</span><span class="token punctuation">:</span>Function
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">CodeUri</span><span class="token punctuation">:</span> ../dist/create<span class="token punctuation">-</span>poll/create<span class="token punctuation">-</span>poll.zip
        <span class="token key atrule">Handler</span><span class="token punctuation">:</span> index.handler
        <span class="token key atrule">Runtime</span><span class="token punctuation">:</span> nodejs6.10
        <span class="token key atrule">Policies</span><span class="token punctuation">:</span> AmazonDynamoDBFullAccess
        <span class="token key atrule">Events</span><span class="token punctuation">:</span>
            <span class="token key atrule">CreatePoll</span><span class="token punctuation">:</span>
                <span class="token key atrule">Type</span><span class="token punctuation">:</span> Api
                <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
                <span class="token key atrule">Path</span><span class="token punctuation">:</span> /polls
                <span class="token key atrule">Method</span><span class="token punctuation">:</span> POST
        <span class="token key atrule">Environment</span><span class="token punctuation">:</span>
            <span class="token key atrule">Variables</span><span class="token punctuation">:</span>
                <span class="token key atrule">TABLE_NAME</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> Polls
</code></pre>
<p>Here you can see we&apos;ve added a new function with a <strong>Logical ID</strong> of <code>CreatePoll</code>, and pointed it at the transpiled, packaged, and minified webpack output for the function script.  We&apos;ve also given the function a managed policy, <code>AmazonDynamoDBFullAccess</code>, that gives it full access to <a href="../GLOSSARY.html#dynamodb" class="glossary-term" title="AWS&apos;s highly scalable document-based NoSQL database solution">DynamoDB</a> resources.  While this isn&apos;t the best idea for production use and you&apos;d want to define a role with more limited scope (which you can do right in the <a href="../GLOSSARY.html#cloudformation" class="glossary-term" title="AWS&apos;s infrastructure-as-code service">CloudFormation</a> template and reference directly!), it will be fine for our purposes. We&apos;ve also defined the event triggers for the function, in this case an <a href="../GLOSSARY.html#api-gateway" class="glossary-term" title="AWS service that facilitates the creation and management of scalable and secure APIs">API Gateway</a> route of <code>/polls</code> with a <code>POST</code> HTTP method.  Finally, we&apos;ve given the function access to an environment variable called <code>TABLE_NAME</code>, which we already used in the function code to fetch the table name. We&apos;ve then used the !Ref intrinsic function to obtain the table name from the resource defined above.  This is necessary because while we&apos;ve given the table a <em>logical name</em> of <code>Polls</code>, the physical name will be a generated value consisting of the stack name, the logical name, and a random identifier at deploy time.</p>
<p>===</p>
<p>With our first function authored, let&apos;s do a quick test to see how we&apos;re doing so far. Let&apos;s generate a mock payload using <code>sam-local</code>:</p>
<pre class="language-"><code class="lang-bash">$ sam local generate-event api -m POST -b <span class="token string">&quot;{\\\&quot;title\\\&quot;:\\\&quot;Test Poll\\\&quot;, \\\&quot;question\\\&quot;: \\\&quot;Which bear is best?\\\&quot;, \\\&quot;answers\\\&quot;: [{\\\&quot;answer\\\&quot;:\\\&quot;Black Bear\\\&quot;, \\\&quot;votes\\\&quot;:0},{\\\&quot;answer\\\&quot;:\\\&quot;That&apos;s debatable...\\\&quot;, \\\&quot;votes\\\&quot;:0}]}&quot;</span> <span class="token operator">&gt;</span> mocks/create-poll.json
</code></pre>
<p>Now, we&apos;ll need a local <a href="../GLOSSARY.html#dynamodb" class="glossary-term" title="AWS&apos;s highly scalable document-based NoSQL database solution">DynamoDB</a> table to use for testing.  To start up the local Dynamo server that we downloaded earlier, navigate to the directory you extracted it to and run the following (do this in a separate terminal as we want to keep it running from now on):</p>
<pre class="language-"><code class="lang-bash">$ java -Djava.library.path<span class="token operator">=</span>./DynamoDBLocal_lib -jar DynamoDBLocal.jar -sharedDb
</code></pre>
<p> let&apos;s create a table to use for our testing. We&apos;ll do so using the CLI:</p>
<pre class="language-"><code class="lang-bash">$ aws dynamodb create-table --region us-west-2 \
                            --table-name poll-testdb \
                            --attribute-definitions AttributeName<span class="token operator">=</span>id,AttributeType<span class="token operator">=</span>S \
                            --key-schema AttributeName<span class="token operator">=</span>id,KeyType<span class="token operator">=</span>HASH \
                            --provisioned-throughput ReadCapacityUnits<span class="token operator">=</span>5,WriteCapacityUnits<span class="token operator">=</span>5 \
                            --endpoint-url http://localhost:8000
</code></pre>
<p>Note that this is the exact same CLI command you&apos;d use to provision a real <a href="../GLOSSARY.html#dynamodb" class="glossary-term" title="AWS&apos;s highly scalable document-based NoSQL database solution">DynamoDB</a> table, with the simple addition of an <code>endpoint-url</code> parameter to redirect the request to the local server.</p>
<p>Earlier we talked about setting up an alias so the container-bound function can find the local mock-Dynamo server.  Let&apos;s do that now:</p>
<pre class="language-"><code>$ sudo ifconfig lo0 alias 172.16.123.1
</code></pre><p>Run <code>webpack</code> to generate the function package:</p>
<pre class="language-"><code class="lang-bash">$ webpack
</code></pre>
<p>Now let&apos;s invoke the function using <code>sam-local</code>, sending our mock event as the payload:</p>
<pre class="language-"><code class="lang-bash">$ TABLE_NAME<span class="token operator">=</span><span class="token string">&quot;poll-test&quot;</span> sam local invoke CreatePoll -e mocks/create-poll.json
</code></pre>
<p>Note that we passed the environment variables needed by the function directly to <code>sam-local</code>.  Even if they are defined in the <a href="../GLOSSARY.html#cloudformation" class="glossary-term" title="AWS&apos;s infrastructure-as-code service">CloudFormation</a> template, <code>sam-local</code> will not pick them up so this is necessary.</p>
<p>If everything went okay, you should see <code>{&quot;statusCode&quot;:200,&quot;body&quot;:{}}</code> at the bottom of the output.  You can use the CLI to check:</p>
<pre class="language-"><code class="lang-bash">$ aws dynamodb scan --table-name poll-test --endpoint http://localhost:8000
<span class="token punctuation">{</span>
    <span class="token string">&quot;Items&quot;</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;createdAt&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;N&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;1518585027076&quot;</span>
            <span class="token punctuation">}</span>,
            <span class="token string">&quot;question&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;S&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;Which bear is best?&quot;</span>
            <span class="token punctuation">}</span>,
            <span class="token string">&quot;answers&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;L&quot;</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        <span class="token string">&quot;M&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                            <span class="token string">&quot;answer&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;S&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;Black Bear&quot;</span>
                            <span class="token punctuation">}</span>,
                            <span class="token string">&quot;votes&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;N&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;0&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>,
                    <span class="token punctuation">{</span>
                        <span class="token string">&quot;M&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                            <span class="token string">&quot;answer&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;S&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;That&apos;s debatable...&quot;</span>
                            <span class="token punctuation">}</span>,
                            <span class="token string">&quot;votes&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;N&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;0&quot;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>,
            <span class="token string">&quot;id&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;S&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;c2a7ca91-a598-4941-8f2e-5dda85482cb9&quot;</span>
            <span class="token punctuation">}</span>,
            <span class="token string">&quot;updatedAt&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;N&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;1518585027076&quot;</span>
            <span class="token punctuation">}</span>,
            <span class="token string">&quot;title&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;S&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;Test Poll&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>,
    <span class="token string">&quot;Count&quot;</span><span class="token keyword">:</span> 1,
    <span class="token string">&quot;ScannedCount&quot;</span><span class="token keyword">:</span> 1,
    <span class="token string">&quot;ConsumedCapacity&quot;</span><span class="token keyword">:</span> null
<span class="token punctuation">}</span>
</code></pre>
<hr>
<p>As you can see, we successfully created a record in the table! Hold on to the id of the returned record, we&apos;ll use it for further tests.  Let&apos;s continue fleshing out the API functionality. In the next section, we&apos;ll create a function to retrieve a single poll record by it&apos;s id.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="dynamo_config.html" class="navigation navigation-prev " aria-label="Previous page: DynamoDB Table Setup">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="get_function.html" class="navigation navigation-next " aria-label="Next page: Get Poll Function">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Create Poll Function","level":"1.3.3","depth":2,"next":{"title":"Get Poll Function","level":"1.3.4","depth":2,"path":"api/get_function.md","ref":"api/get_function.md","articles":[]},"previous":{"title":"DynamoDB Table Setup","level":"1.3.2","depth":2,"path":"api/dynamo_config.md","ref":"api/dynamo_config.md","articles":[]},"dir":"ltr"},"config":{"plugins":["prism","-highlight","fancybox"],"root":"./book","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{},"fancybox":{"helpers":{"buttons":{}}},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"api/create_function.md","mtime":"2018-02-21T06:27:41.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-02-21T10:07:35.533Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.mousewheel.pack.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.fancybox.pack.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/jquery.fancybox-buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fancybox/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

